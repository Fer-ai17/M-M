{% extends "base.html" %}
{% block title %}Pedidos{% endblock %}

{% block content %}
<h2>Historial de compras</h2>

<div style="margin-bottom:1rem; display:flex; gap:8px; align-items:center;">
  <form method="get" class="search-form" style="display:flex; flex:1; gap:8px; align-items:center;">
    <!-- Mantener filtros activos como hidden -->
    {% if date_from %}<input type="hidden" name="date_from" value="{{ date_from }}">{% endif %}
    {% if date_to %}<input type="hidden" name="date_to" value="{{ date_to }}">{% endif %}
    
    <input type="search" name="q" placeholder="Buscar evento..." value="{{ q }}" style="flex:1;">
    <button type="submit">Buscar</button>
  </form>

  <!-- Botón de filtrar que abre el modal -->
  <button id="filter-toggle" aria-expanded="false" title="Filtros" 
          style="background:#f0f0f0; border:1px solid #ddd; padding:4px 10px; cursor:pointer; border-radius:4px;">
    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" style="vertical-align:middle; margin-right:3px;">
      <path d="M3 6h18M6 12h12M10 18h4" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
    </svg>
    Filtrar
    {% if date_from or date_to %}
      <span style="background:#007bff; color:white; border-radius:50%; display:inline-block; width:16px; height:16px; font-size:10px; line-height:16px; text-align:center;">!</span>
    {% endif %}
  </button>
</div>

<!-- Overlay modal para filtros -->
<div id="filter-overlay" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.5); z-index:100;">
  <div id="filter-modal" style="position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); background:white; padding:20px; border-radius:8px; width:90%; max-width:500px; max-height:80vh; overflow-y:auto; z-index:101;">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
      <h3 style="margin:0;">Filtros por fecha</h3>
      <button id="close-filter" style="background:none; border:none; font-size:20px; cursor:pointer;">&times;</button>
    </div>
    
    <form id="filters-form" method="get">
      <!-- Preservar búsqueda -->
      {% if q %}<input type="hidden" name="q" value="{{ q }}">{% endif %}
      
      <div style="margin-bottom:15px;">
        <label style="display:block; margin-bottom:5px; font-weight:500;">Fecha desde</label>
        <input type="date" name="date_from" value="{{ date_from }}" style="width:100%; padding:8px; border:1px solid #ddd; border-radius:4px;">
      </div>

      <div style="margin-bottom:15px;">
        <label style="display:block; margin-bottom:5px; font-weight:500;">Fecha hasta</label>
        <input type="date" name="date_to" value="{{ date_to }}" style="width:100%; padding:8px; border:1px solid #ddd; border-radius:4px;">
      </div>
      
      <div style="display:flex; gap:10px; margin-top:20px;">
        <button type="submit" style="flex:1; background:#007bff; color:white; border:none; padding:10px; border-radius:4px; cursor:pointer;">Aplicar filtros</button>
        <a href="{% url 'bought' %}" style="flex:1; background:#f8f9fa; color:#333; border:1px solid #ddd; padding:10px; border-radius:4px; text-align:center; text-decoration:none;">Limpiar</a>
      </div>
    </form>
  </div>
</div>

<!-- Indicador de filtros activos -->
{% if date_from or date_to %}
<div style="margin-bottom:15px; padding:8px 12px; background:#f8f9fa; border-radius:4px; display:flex; align-items:center; justify-content:space-between;">
  <div>
    <span style="font-weight:500;">Filtros aplicados:</span>
    {% if date_from %}
      <span style="display:inline-block; background:#e7f3ff; border:1px solid #3a99ffff; padding:2px 8px; border-radius:12px; margin:0 5px;">
        Desde: {{ date_from }}
      </span>
    {% endif %}
    {% if date_to %}
      <span style="display:inline-block; background:#e7f3ff; border:1px solid #3a99ffff; padding:2px 8px; border-radius:12px; margin:0 5px;">
        Hasta: {{ date_to }}
      </span>
    {% endif %}
  </div>
  <a href="{% url 'bought' %}" style="color:#6c757d; text-decoration:none; font-size:14px;">Eliminar filtros</a>
</div>
{% endif %}

<table class="table">
  <thead>
    <tr>
      <th>ID</th>
      <th>Evento</th>
      <th>Ubicación</th>
      <th>Fecha</th>
      <th>Total</th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    {% for bought in bought_items %}
      <tr>
        <td>#{{ bought.id }}</td>
        <td>{{ bought.tickets.events.name }}</td>
        <td>{{ bought.tickets.events.location.name }}</td>
        <td>{{ bought.created_at|date:"d/m/Y H:i" }}</td>
        <td>${{ bought.total }}</td>
        <td><a href="{% url 'bought_detail' bought.id %}">Ver detalles</a></td>
      </tr>
    {% empty %}
      <tr><td colspan="6">No hay compras que coincidan con los filtros.</td></tr>
    {% endfor %}
  </tbody>
</table>

<script>
  (function(){
    // Referencias a elementos
    const toggleBtn = document.getElementById('filter-toggle');
    const closeBtn = document.getElementById('close-filter');
    const overlay = document.getElementById('filter-overlay');
    const modal = document.getElementById('filter-modal');
    
    if (!toggleBtn || !overlay || !closeBtn) return;
    
    // Abrir modal
    toggleBtn.addEventListener('click', function(e) {
      e.preventDefault();
      overlay.style.display = 'block';
      document.body.style.overflow = 'hidden'; // Previene scroll
    });
    
    // Cerrar modal (botón X)
    closeBtn.addEventListener('click', function() {
      overlay.style.display = 'none';
      document.body.style.overflow = '';
    });
    
    // Cerrar modal al hacer clic en el overlay
    overlay.addEventListener('click', function(e) {
      if (e.target === overlay) {
        overlay.style.display = 'none';
        document.body.style.overflow = '';
      }
    });
    
    // Prevenir que el clic en el modal cierre el overlay
    modal.addEventListener('click', function(e) {
      e.stopPropagation();
    });
    
    // Cerrar con ESC
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape' && overlay.style.display === 'block') {
        overlay.style.display = 'none';
        document.body.style.overflow = '';
      }
    });
  })();
</script>
{% endblock %}
