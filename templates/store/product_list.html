{% extends "base.html" %}
{% block title %}Tienda{% endblock %}

{% block content %}
<h1>Nuestros Eventos</h1>

<div style="margin-bottom:1rem; display:flex; gap:8px; align-items:center;">
  <form method="get" class="search-form" style="display:flex; flex:1; gap:8px; align-items:center;">
    <!-- Mantener filtros activos como hidden -->
    {% if municipality_q %}<input type="hidden" name="municipality" value="{{ municipality_q }}">{% endif %}
    {% if label %}<input type="hidden" name="label" value="{{ label }}">{% endif %}
    
    <input type="search" name="q" placeholder="Buscar..." value="{{ q }}" style="flex:1;">
    <button type="submit">Buscar</button>
  </form>

  <!-- Botón de filtrar que abre el modal -->
  <button id="filter-toggle" aria-expanded="false" title="Filtros" 
          style="background:#f0f0f0; border:1px solid #ddd; padding:4px 10px; cursor:pointer; border-radius:4px;">
    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" style="vertical-align:middle; margin-right:3px;">
      <path d="M3 6h18M6 12h12M10 18h4" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
    </svg>
    Filtrar
    {% if municipality_q or label %}
      <span style="background:#007bff; color:white; border-radius:50%; display:inline-block; width:16px; height:16px; font-size:10px; line-height:16px; text-align:center;">!</span>
    {% endif %}
  </button>
</div>

<!-- Overlay modal para filtros -->
<div id="filter-overlay" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.5); z-index:100;">
  <div id="filter-modal" style="position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); background:white; padding:20px; border-radius:8px; width:90%; max-width:500px; max-height:80vh; overflow-y:auto; z-index:101;">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
      <h3 style="margin:0;">Filtros de búsqueda</h3>
      <button id="close-filter" style="background:none; border:none; font-size:20px; cursor:pointer;">&times;</button>
    </div>
    
    <form id="filters-form" method="get">
      <!-- Preservar búsqueda -->
      {% if q %}<input type="hidden" name="q" value="{{ q }}">{% endif %}
      
      <div style="margin-bottom:15px;">
        <label style="display:block; margin-bottom:5px; font-weight:500;">Municipio</label>
        <select name="municipality" style="width:100%; padding:8px; border:1px solid #ddd; border-radius:4px;">
          <option value="">Todos los municipios</option>
          {% for m in municipalities %}
            <option value="{{ m.id }}" {% if m.id|stringformat:"s" == municipality_q %}selected{% endif %}>{{ m.name }}</option>
          {% endfor %}
        </select>
      </div>

      <div style="margin-bottom:15px;">
        <label style="display:block; margin-bottom:5px; font-weight:500;">Tipo de evento</label>
        <select name="label" style="width:100%; padding:8px; border:1px solid #ddd; border-radius:4px;">
          <option value="">Todos los tipos</option>
          <option value="proximamente" {% if label == "proximamente" %}selected{% endif %}>Próximamente</option>
          <option value="preventa" {% if label == "preventa" %}selected{% endif %}>Preventa</option>
          <option value="ninguno" {% if label == "ninguno" %}selected{% endif %}>Ninguno</option>
        </select>
      </div>
      
      <div style="display:flex; gap:10px; margin-top:20px;">
        <button type="submit" style="flex:1; background:#007bff; color:white; border:none; padding:10px; border-radius:4px; cursor:pointer;">Aplicar filtros</button>
        <a href="{% url 'events_list' %}" style="flex:1; background:#f8f9fa; color:#333; border:1px solid #ddd; padding:10px; border-radius:4px; text-align:center; text-decoration:none;">Limpiar</a>
      </div>
    </form>
  </div>
</div>

<!-- Indicador de filtros activos -->
{% if municipality_q or label %}
<div style="margin-bottom:15px; padding:8px 12px; background:#f8f9fa; border-radius:4px; display:flex; align-items:center; justify-content:space-between;">
  <div>
    <span style="font-weight:500;">Filtros aplicados:</span>
    {% if municipality_q %}
      {% for m in municipalities %}
        {% if m.id|stringformat:"s" == municipality_q %}
          <span style="display:inline-block; background:#e7f3ff; border:1px solid #3a99ffff; padding:2px 8px; border-radius:12px; margin:0 5px;">
            {{ m.name }}
          </span>
        {% endif %}
      {% endfor %}
    {% endif %}
    {% if label %}
      {% if label == "proximamente" %}
        <span style="display:inline-block; background:#fff3cd; border:1px solid #fcde84ff; padding:2px 8px; border-radius:12px; margin:0 5px;">
          Próximamente
        </span>
      {% elif label == "preventa" %}
        <span style="display:inline-block; background:#d4edda; border:1px solid #6ae086ff; padding:2px 8px; border-radius:12px; margin:0 5px;">
          Preventa
        </span>
      {% elif label == "ninguno" %}
        <span style="display:inline-block; background:#f5f5f5; border:1px solid #8db9e6ff; padding:2px 8px; border-radius:12px; margin:0 5px;">
          Ninguno
        </span>
      {% endif %}
    {% endif %}
  </div>
  <a href="{% url 'events_list' %}" style="color:#6c757d; text-decoration:none; font-size:14px;">Eliminar filtros</a>
</div>
{% endif %}

<div class="product-grid" style="display:grid; grid-template-columns:repeat(auto-fill,minmax(220px,1fr)); gap:12px;">
  {% for event in events %}
    <div class="product-card" style="border:1px solid #eee; padding:10px; border-radius:6px; box-shadow:0 2px 4px rgba(0,0,0,0.05);">
      {% if event.label != "ninguno" %}
        <span class="badge" style="background:{% if event.label == 'proximamente' %}#001570{% elif event.label == 'preventa' %}#CFD406{% else %}#f5f5f5{% endif %}; padding:2px 6px; border-radius:3px; font-size:12px; display:inline-block; margin-bottom:5px;">
          {{ event.get_label_display }}
        </span>
      {% endif %}

      <div class="product-info">
        <h3 style="margin:8px 0; font-size:16px;">
          <a href="{% url 'events_detail' event.pk %}" style="text-decoration:none; color:#212529;">{{ event.name }}</a>
        </h3>

        <p class="desc" style="color:#555; margin:8px 0; font-size:14px;">{{ event.description|default:"Sin descripción"|truncatechars:80 }}</p>
        <p class="stock" style="font-size:0.9rem; color:#333; margin:5px 0;">Disponibles: {{ event.location.stock|default:"N/D" }}</p>

        {% if event.location.stock|default:0 > 0 %}
          <a href="{% url 'add_to_cart' event.pk %}" class="btn" style="display:inline-block;margin-top:8px;padding:6px 10px;background:#007bff;color:#fff;border-radius:4px;text-decoration:none; border:none; width:100%; text-align:center;">Añadir al carrito</a>
        {% else %}
          <p class="out-of-stock" style="color:#cc0000;margin-top:8px; text-align:center; padding:6px; background:#f8d7da; border-radius:4px;">Agotado</p>
        {% endif %}
      </div>
    </div>
  {% empty %}
    <div style="grid-column:1/-1; text-align:center; padding:20px; background:#f8f9fa; border-radius:8px;">
      <p style="margin:0; color:#6c757d;">No hay eventos que coincidan con la búsqueda.</p>
    </div>
  {% endfor %}
</div>

<script>
  (function(){
    // Referencias a elementos
    const toggleBtn = document.getElementById('filter-toggle');
    const closeBtn = document.getElementById('close-filter');
    const overlay = document.getElementById('filter-overlay');
    const modal = document.getElementById('filter-modal');
    
    if (!toggleBtn || !overlay || !closeBtn) return;
    
    // Abrir modal
    toggleBtn.addEventListener('click', function(e) {
      e.preventDefault();
      overlay.style.display = 'block';
      document.body.style.overflow = 'hidden'; // Previene scroll
    });
    
    // Cerrar modal (botón X)
    closeBtn.addEventListener('click', function() {
      overlay.style.display = 'none';
      document.body.style.overflow = '';
    });
    
    // Cerrar modal al hacer clic en el overlay
    overlay.addEventListener('click', function(e) {
      if (e.target === overlay) {
        overlay.style.display = 'none';
        document.body.style.overflow = '';
      }
    });
    
    // Prevenir que el clic en el modal cierre el overlay
    modal.addEventListener('click', function(e) {
      e.stopPropagation();
    });
    
    // Cerrar con ESC
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape' && overlay.style.display === 'block') {
        overlay.style.display = 'none';
        document.body.style.overflow = '';
      }
    });
  })();
</script>
{% endblock %}